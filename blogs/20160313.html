
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>DevOps Glue AWS - LINUX  - NodeJS - AJAX - MySQL - Web</title>
    <!-- Bootstrap Core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../css/clean-blog.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <!-- Js Functions -->
    <script src="../js/ajax.js"></script> 

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
   
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://au.linkedin.com/in/jamkwok">James Kwok</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="../index.html">Home</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header" style="background-image: url('../img/20160313.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div id="blogtitle" class="post-heading">
                    </div>
                </div>
            </div>
        </div>
    </header>
    
   <script> getBlogTitle("20160313");</script>

    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <p>Iptables is a very powerful firewall for linux. These tips and tricks can help you make the most out of your iptables where an actual firewall may not exist.</p>

		    <p>Sample Iptables example:</p>
		    <div class="bootstrap-demo">
  			<pre><p>
vi /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7 on Sun Mar 30 14:54:27 2014
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
#MASQUERADE
-A PREROUTING -i eth0 -p tcp -m tcp --dport 3389 -j DNAT --to-destination 192.168.0.53:3389
-A POSTROUTING -o eth0 -j MASQUERADE
COMMIT
# Completed on Sun Mar 30 14:54:27 2014
# Generated by iptables-save v1.4.7 on Sun Mar 30 14:54:27 2014
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [129:15496]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
#SSH LIMIT CONNECTION PER SECOND
-A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set
-A INPUT -p tcp --dport 22 -m state --state NEW -m recent  --update --seconds 120 --hitcount 4 -j DROP
#SSH REMOTE EXAMPLE
-A INPUT -s 1.1.1.1/24 -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
#DROP EXAMPLE
-A INPUT -j DROP
#FORWARD EXAMPLE FOR GATEWAY			
-A FORWARD -i eth0 -o eth0 -s 192.168.0.0/24  -j ACCEPT
-A FORWARD -j DROP
COMMIT

service iptables restart
			</p></pre>
		    </div>
		    <p> Masquerade example: The following example is actually a security vulnerability and is only used to demonstrate a possible use case. Lets say you have several non priviledged users who need to be able to RDP to a box on the DMZ. Your firewall administrator is not happy about constantly creating firewall rules for these users to the dmz box on 3389. The solution here is to use iptables to port forward users to the this DMZ box. Lets say the box has an ip of 192.168.0.53 in the DMZ. We ask our firewall administrator to create one rule from our linux box to the windows box in the dmz on port 3389. When users connect to our linux box on port 3389, the masquerade rule will store their ip on the server and swap in , it's own ip before forwarding to the windows dmz box. To the firewall in between the linux and dmz windows box, the traffic will appear to have originated from the linux box which is all good. When packets return the masquerade rule will swap out the destination back to the users ip, so the packets can get back to the user's computer. Masquerading is very powerful and has legitimate uses in VIPs which appear on the same subnet as the its nodes and the requestor. Sometimes when traffic hits the VIP and then to the node it may travel back directly to the requestor and not return via the VIP. Of course the original requestor will drop the connection because it would have sent to the VIP but receive directly from the node. If the VIP is a linux box masquerading will guarantee that traffic will always return through the VIP.</p>

		    <p> SSH example: Say you want to ssh to your home box which you have port forwarded from your router. The problem with leaving it completely open is that you'll notice quickly in /var/log/secure many malicious attackers trying to brute force their way into your machine. The best way to close the hole is with iptables if your router is not sophisticated enough to have a proper firewall. On the first day you ssh into your machine from your work place. Assuming your work's IP is static and there isn't more than one, we can look up the address of where we came from in /var/log/secure. We then pop this IP into iptables, for demonstration purposes we have made this 1.1.1.1 and we then proceed to start iptables. This accept rule means that ssh connections coming from that IP only will be accepted. However after this rule a DROP or REJECT is required to terminate all other connections from other sources. </p>

		    <p> SSH LIMIT CONNECTION PER SECOND: These rules will only allow 4 connections from the same source ip for 120 seconds as configured. This is only for new incoming connections and is great for bruteforce attacks when used with sshd config that closes the connection after 1 invalid attempt as shown below.</p>
		   
		    <p> Close connection after 1 unsuccessful attempt:</p>
                    <div class="bootstrap-demo">
                        <pre><p>
vi /etc/ssh/sshd_config
MaxAuthTries 1

service sshd restart
                        </p></pre>
                    </div>
 

		    <p> DROP Example: As stated in the SSH example, a DROP or REJECT is required as the last rule for INPUT to catch conditions that your ACCEPT rule did not ACCEPT. DROP is better than REJECT, because a DROP does not return an acknowledgment to the source. With a REJECT an acknowledgment is sent and the sender will immediately realise that a firewall rule has blocked them. A drop will waste a few seconds of their time and will more likely cloak the fact you are have an active firewall rule shielding the site.</p>

		    <p> FORWARD Example: Gateways are used to connect different network subnets together. However lets say the linux box is being used as a gateway and has 3 subnets connected to it. However you only want packets originating from the 192.168.0.0/24 subnet to use this box as a gateway. Firestly you would need to enable ip forwarding on this linux box as show below, but a forward accept rule with -s to specify the source subnet and drop all else will allow this linux box to only act as a gateway for the specified subnet</p>

		    <p>Enable Ip Forwarding in Redhat:</p>
                    <div class="bootstrap-demo">
                        <pre><p>
vi /etc/sysctl.conf
net.ipv4.ip_forward = 1

sysctl -p /etc/sysctl.conf
			</p></pre>
		    </div>

		    <p> DROP Example: As stated in the SSH example, a DROP or REJECT is required as the last rule for INPUT to catch conditions that your ACCEPT rule did not ACCEPT. DROP is better than REJECT, because a DROP does not return an acknowledgment to the source. With a REJECT an acknowledgment is sent and the sender will immediately realise that a firewall rule has blocked them. A drop will waste a few seconds of their time and will more likely cloak the fact you are have an active firewall rule shielding the site.</p>


		    <hr>
                    <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//iptablesdevopsgluecom.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> 
                </div>
            </div>
        </div>
    </article>
    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://twitter.com/jameszkwok">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.facebook.com/james.kwok.334">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://au.linkedin.com/in/jamkwok">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                     <p class="copyright text-muted">Copyright &copy; DevOpsGlue.com 2016</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="../js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../js/clean-blog.min.js"></script>

</body>

</html>

